<!DOCTYPE html>
<html lang="en">
<head>
<title>BERRYCREPE BINGO</title>

<meta charset="UTF-8" />
<meta name="description" content="Bingo card for twitch.tv/berrycrepe" />
<meta name="keywords" content="BerryCrepe, bingo, twitch, twitch.tv" />
<meta name="author" content="nativefig" />
<meta name="google-site-verification" content="nEs3VBddwiBkWqrW60thOsIcsHEvQjFGLOXb-TZU4dU" />

<style>
    .center {
        display: flex;
        justify-content: center;
    }
    @media screen and (orientation:landscape) {
        .body_table {
            height: 75vmin;
        }
        .centered {
                width: 75vmin;
        }
    }
    @media screen and (orientation:portrait) {
        .body_table {
            height: 95vmin;
        }
        .centered {
                width: 95vmin;
        }
    }

    table {
        border-collapse: separate;
        border-spacing: 1vmin 1vmin;
        width: 100%;
    }
    td {
        padding-left: 1.5%;
        padding-right: 1.5%;
        background-color: seashell;
        box-shadow: 0.2vmin 0.2vmin 0.6vmin rgba(0, 0, 0, 0.5);
        border-radius: 0.5vmin;
    }

    .head_table {
        border-spacing: 1vmin 0;
    }
    .head_table td {
        box-shadow: none;
        width: 20%;
        color: seashell;
        background-color: inherit;
        font-weight: bold;
        text-align: center;
        font-size: 3.0vmin;
    }
    .body_table td {
        width: 20%;
        height: 20%;
        text-align: center;
        cursor: pointer;
    }
    .button_table td {
        text-align: center;
        width: 20%;
    }
    body {
        color: #202020;
        font-family: Arial, sans-serif;
        font-size: 1.8vmin;
    }
    a {
        color: inherit;
        text-decoration: inherit;
    }
    html {
        height: 100vh;
        background-image: linear-gradient(#B4557D, #3F5273);
    }

    .button {
        height: 3.2vmin;
        cursor: pointer;
    }
    #url_box {
        height: 3vmin;
    }

    .hidden {
        visibility: hidden;
    }
    .checked {
        background-color: #ffb347 !important;
    }
    .checked.blueguy {
        background-color: #108dc7 !important;
    }
    .blur_unchecked td:not(.checked) {
        color: transparent;
        text-shadow: 0 0 1vmin rgba(0,0,0,0.8);
    }
    .small_text {
        font-size: 1.7vmin;
    }
    .bingo_state td {
        color: #ffb347 !important;
        text-shadow: 0 0 1vmin #ffb347;
    }
</style>
</head>

<body>
<div class="center">
<div class="centered">

<table class="head_table">
<tr><td><div>B</div></td><td><div>E</div></td><td><div>R</div></td><td><div>R</div></td><td><div>Y</div></td></tr>
<tr><td><div>C</div></td><td><div>R</div></td><td><div>E</div></td><td><div>P</div></td><td><div>E</div></td></tr>
<tr id="bingo"><td><div>B</div></td><td><div>I</div></td><td><div>N</div></td><td><div>G</div></td><td><div>O</div></td></tr>
</table>

<table class="body_table">
</table>

<table class="button_table">
<tr>
    <td id="url_button" class="button" onclick="clicked_url_button()">
        Share card
    </td>
    <td class="hidden"> </td>
    <td id="hide_button" class="button" onclick="clicked_hide_button()">
        Hide
    </td>
    <td class="button" onclick="clicked_reset_button()">
        Reset
    </td>
    <td class="button" onclick="clicked_new_button()">
        New card
    </td>
</tr>
</table>

<table>
<tr>
    <td id="url_box" class="hidden">
        <a id="url_link" href=""></a>
    </td>
</tr>
</table>

</div>
</div>

<script>
const bingo_size = 5;
const bingo_num_cells = bingo_size * bingo_size;
const free_square_idx = (bingo_num_cells - 1) / 2;

const param_str_base = 32;

const url_box = document.getElementById("url_box");
const url_button = document.getElementById("url_button");
const url_link = document.getElementById("url_link");
const hide_button = document.getElementById("hide_button");
const body_table = document.querySelector(".body_table");

const cells_text = [
    '"I just spit everywhere, I\'m so spitty"',
    '"I don\'t know how to explain it"',
    '"I\'m gonna get in trouble"',
    '"Popeyes called me stupid"',
    '"I don\'t know what we\'re doing tomorrow"',
    '"Feet aren\'t free"',
    '"It\'s not a vape"',
    '"I signed the DARE contract"',
    '"I hope my dad isn\'t watching"',
    '"Do I have a coomer chat?"',
    '"I\'ve been yelling a lot less, I used to be worse"',
    '"Gawk gawk 9000"',
    [
        1,
        '"I\'m not a furry"',
        '"Catgirls are not furries"',
    ],
    '"Don\'t look at my YouTube recommended videos"',
    '"Soda is spicy"',
    [
        1,
        '"Are you shitting my dick off"',
        '"Are you shitting my asshole"',
        '"Are you fucking my nuts off"',
    ],
    [
        1,
        'Spills something on mousepad',
        'Spills something on keyboard',
    ],
    [
        1,
        'Yells "watch your mouth" at someone in chat',
        'Yells "I don\'t like your attitude" at someone in chat',
    ],
    'Speaks gibberish when someone resubs',
    [
        1,
        'Threatens to cry on stream',
        'Cries on stream',
    ],
    [
        1,
        'Tells the Fritos story again',
        'Refuses to tell the Fritos story again',
    ],
    'Makes a JoJo reference',
    'Uses a bad MS Paint drawing to explain something',
    'Threatens chat by holding a knife to the camera',
    'Talks about people who hate her',
    'Uses the word "cooch-hole"',
    'Throws up on or off cam',
    'BlueGuy',
    'Hides sweaty armpits by covering them with hands',
    'Threatens to fire a mod',
    'Tells a cringe inducing story from her childhood',
    'Explains some zoomer shit she learned on TikTok',
    'Describes a food as "It\'s not that bad"',
    'Calls someone an "Andy"',
    'Tells chat that she doesn\'t want to peg us',
    'Talks about cartoon animals with sexual energy',
    'Talks about how great Buc-ee\'s is',
    'Abuses Koby',
    'Claims to be a millionaire',
    [
        'Tells chat to stop talking about cum',
        'Talks about cum',
    ],
    'Asks chat if she\'s allowed to pee',
    'Any sentence of two words or more repeated three times or more in a row',
    'Technical difficulties',
    [
        1,
        'Mentions someone pissing their pants',
        'Mentions someone shitting their pants',
    ],
    'Talks shit about DS2 or DS2 viewers',
    [
        'Ironically promotes incest',
        'Unironically denounces incest',
    ],
    'Says "PUSSY" in a weird, high-pitched voice',
];

// Mutable global data
var rand = null;
var cells = null;
var blur = false;
var seed = null;

function assert(cond, msg) {
    if (!cond) {
        throw msg;
    }
}

function hash(str) {
    var hash = 0;
    if (str.length === 0) {
        return hash;
    }
    for (var i = 0; i < str.length; i++) {
        var ch = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + ch;
        hash = hash & hash; // Convert to 32bit integer
    }
    return hash;
}

function splitmix32(a) {
    return function() {
      a |= 0; a = a + 0x9e3779b9 | 0;
      var t = a ^ a >>> 15; t = Math.imul(t, 0x85ebca6b);
      t = t ^ t >>> 13; t = Math.imul(t, 0xc2b2ae35);
      return ((t = t ^ t >>> 16) >>> 0) / 4294967296;
    }
}

function set_cookie(name, value, expire_days) {
    let d = new Date();
    d.setTime(d.getTime() + (expire_days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${value}; expires=${d.toUTCString()}; samesite=strict; path=/`;
}

function get_cookies() {
    let result = new Map();
    for (let key_val of document.cookie.split(';')) {
        key_val.trim();
        let eq = key_val.indexOf("=");
        if (eq === -1) {
            result.set(key_val, "");
        } else {
            let key = key_val.slice(0, eq);
            key.trim();
            let val = key_val.slice(eq + 1);
            val.trim();
            result.set(key, val);
        }
    }
    return result;
}

function shuffle(array) {
    let currentIndex = array.length;
    while (0 !== currentIndex) {

        // Pick a remaining element...
        let randomIndex = Math.floor(rand() * currentIndex);
        currentIndex -= 1;

        // And swap it with the current element.
        let temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
    }
}

function get_page_url_no_params() {
    return window.location.href.split("?")[0];
}

function is_bingo() {
    const bits = get_card_state() | (1 << free_square_idx);
    let hmask = 0x1f;
    let vmask = 0x108421;
    for (let i = 0; i < bingo_size; ++i) {
        if ((bits & hmask) === hmask || (bits & vmask) === vmask)
            return true;
        vmask <<= 1;
        hmask <<= bingo_size;
    }
    const dmask1 = 0x1041041;
    const dmask2 = 0x111110;
    return ((bits & dmask1) === dmask1 || (bits & dmask2) === dmask2)
}
function detect_bingo() {
    const bingo_text = document.getElementById("bingo");
    bingo_text.classList.toggle("bingo_state", is_bingo());
}

function update_url_box() {
    let page = get_page_url_no_params();
    let state = get_card_state().toString(param_str_base);
    let url = `${page}?seed=${seed}&state=${state}`;
    if (blur) {
        url += "&blur";
    }
    url_link.innerText = url;
    url_link.setAttribute("href", url);
}

function refresh_state() {
    update_url_box();
    update_blur();
    detect_bingo();
}

function is_checked(cell) {
    return cell.classList.contains("checked");
}
function toggle_cell(cell) {
    let checked = cell.classList.toggle("checked");
}
function clicked_cell(cell_id) {
    toggle_cell(cells[cell_id]);
    update_url_box();
    detect_bingo();
}

function clicked_url_button() {
    if (url_box.classList.toggle("hidden")) {
        url_button.innerText = "Share card";
    } else {
        url_button.innerText = "Hide link";
    }
}
function clicked_reset_button() {
    for (let cell of cells) {
        cell.classList.remove("checked");
    }
    blur = false;
    refresh_state();
}
function clicked_new_button() {
    set_cookie("id", "", 0);
    window.location = get_page_url_no_params();
}
function update_blur() {
    body_table.classList.toggle("blur_unchecked", blur);
}
function clicked_hide_button() {
    blur = !blur;
    if (blur) {
        hide_button.innerText = "Show";
    } else {
        hide_button.innerText = "Hide";
    }
    update_url_box();
    update_blur();
}

function gen_table(table, strings) {
    assert(strings.length === bingo_num_cells - 1);
    let cells = [];
    let fixup = 0;
    for (let i = 0; i < bingo_size; ++i) {
        let row_elem = table.insertRow();
        for (let j = 0; j < bingo_size; ++j) {
            let cell = document.createElement("td");
            let text;
            if (cells.length === free_square_idx) {
                text = "Free space!";
                cell.classList.add("checked");
                // Add a dummy square to cells
                cells.push(document.createElement("td"));
                // Apply offset to positions to account for the free space
                fixup = 1;
            } else {
                text = strings[cells.length - fixup];
                cell.setAttribute("onclick", `clicked_cell(${cells.length})`);
                cells.push(cell);
            }

            if (text.length > 60) {
                cell.classList.add("small_text");
            }
            if (text.includes("BlueGuy")) {
                cell.classList.add("blueguy");
            }
            cell.appendChild(document.createTextNode(text));
            row_elem.appendChild(cell);
        }
    }
    return cells;
}

function get_card_state() {
    let bits = 0;
    let bit_count = 0;
    for (let cell of cells) {
        if (is_checked(cell)) {
            bits |= 1 << bit_count;
        }
        ++bit_count;
    }
    return bits;
}

function main() {
    let search_params = new URLSearchParams(window.location.search);

    blur = search_params.has("blur");

    seed = search_params.get("seed");
    if (seed === null) {
        let cookies = get_cookies();
        let unique_id = cookies.get("id");
        if (!unique_id) {
            let id_int = Math.floor(Math.random() * (1 << 20));
            unique_id = id_int.toString(param_str_base);
            set_cookie("id", unique_id, 0.5);
        }
        seed = unique_id;
    }

    rand = splitmix32(hash(seed));

    let strings = [];
    {
        let remaining = [...cells_text];
        // Minus one to account for free space
        while (strings.length < (bingo_num_cells - 1)) {
            if (remaining.length === 0) {
                // If we don't have enough items, add dupes
                remaining = [...cells_text];
            }
            let index = Math.floor(rand() * remaining.length);
            let chosen = remaining[index];
            if (typeof(chosen) === "string") {
                strings.push(chosen);
            } else if (typeof(chosen[0]) === "number") {
                let choices = chosen.slice(1);
                shuffle(choices);
                let take = chosen[0];
                for (let choice of choices) {
                    if (take <= 0)
                        break;
                    --take;
                    strings.push(choice);
                }
            } else {
                for (let elem of chosen) {
                    strings.push(elem);
                }
            }
            remaining.splice(index, 1);
        }
    }
    shuffle(strings);

    let table = document.querySelector(".body_table");
    cells = gen_table(table, strings);
    assert(cells.length === bingo_num_cells);

    let state_str = search_params.get("state");
    if (state_str !== null) {
        let state_num = parseInt(state_str, param_str_base);
        for (let i = 0; i < cells.length; ++i, state_num >>>= 1) {
            if (state_num & 1) {
                toggle_cell(cells[i]);
            }
        }
    }
    refresh_state();
}

main();

</script>
</body>
</html>
