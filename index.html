<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>B E R R Y C R E P E B I N G O</title>
</head>

<body>
<div class="center">
<div class="centered">

<table class="head_table ">
<tr><td><div>B</div></td><td><div>E</div></td><td><div>R</div></td><td><div>R</div></td><td><div>Y</div></td></tr>
<tr><td><div>C</div></td><td><div>R</div></td><td><div>E</div></td><td><div>P</div></td><td><div>E</div></td></tr>
<tr><td><div>B</div></td><td><div>I</div></td><td><div>N</div></td><td><div>G</div></td><td><div>O</div></td></tr>
</table>

<table class="body_table">
</table>

<table class="button_table">
<tr>
    <td id="url_button" class="button" onclick="clicked_url_button()">
        Share this card
    </td>
    <td class="hidden"> </td>
    <td class="hidden"> </td>
    <td class="hidden"> </td>
    <td id="reset_button" class="button" onclick="clicked_reset_button()">
        Reset
    </td>
</tr>
</table>

<table>
<tr>
    <td id="url_box" class="hidden"> </td>
</tr>
</table>

<div id="spam_box" class="">
</div>

</div>
</div>
</body>

<style>
    .center {
        display: flex;
        justify-content: center;
    }
    @media screen and (orientation:landscape) {
        .body_table {
            height: 75vmin;
        }
        .centered {
                width: 75vmin;
        }
    }
    @media screen and (orientation:portrait) {
        .body_table {
            height: 85vmin;
        }
        .centered {
                width: 85vmin;
        }
    }

    .show_border {
        border: 1px solid #202020;
    }

    table {
        border-collapse: separate;
        border-spacing: 1vmin 1vmin;
        width: 100%;
    }
    td {
        padding-left: 1.5%;
        padding-right: 1.5%;
        background-color: seashell;
        box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);
    }

    .head_table {
        border-spacing: 1vmin 0px;
    }
    .head_table td {
        box-shadow: none;
        width: 20%;
        color: seashell;
        background-color: inherit;
        font-weight: bold;
        text-align: center;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 3.0vmin;
    }
    .body_table td {
        width: 20%;
        height: 20%;
        text-align: center;
        font-size: 1.7vmin;
        cursor: pointer;
    }
    .button_table td {
        text-align: center;
        width: 20%;
    }
    body {
        color: #202020;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 1.7vmin;
    }
    html {
        height: 100vh;
        //background-image: linear-gradient(thistle, orchid);
        //background-image: linear-gradient(#F3904F, #3B4371);
        background-image: linear-gradient(#B4557D, #3F5273);
    }

    .button {
        height: 3vmin;
        cursor: pointer;
    }
    #url_box {
        height: 3vmin;
    }

    .hidden {
        visibility: hidden;
    }
    .checked {
        //border: 2px solid #202020;
        background-color: #F3904F !important;
    }
</style>

<script>
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

const bingo_size = 5;
const bingo_num_cells = bingo_size * bingo_size;
const param_str_base = 32;

const spam_box = document.getElementById("spam_box");
const url_box = document.getElementById("url_box");
const url_button = document.getElementById("url_button");

const cells_text = [
    '"I just spit everywhere, I\'m so spitty"',
    '"I don\'t know how to explain it"',
    '"I\'m gonna get in trouble"',
    '"Popeyes called me stupid"',
    '"I don\'t know what we\'re doing tomorrow"',
    '"Feet aren\'t free"',
    '"It\'s not a vape"',
    '"I signed the DARE contract"',
    '"I hope my dad isn\'t watching"',
    '"Do I have a coomer chat?"',
    '"I\'ve been yelling a lot less, I used to be worse"',
    '"Catgirls are not furries"',
    '"Don\'t look at my YouTube recommended videos"',

    [
        1,
        'Spills something on mousepad',
        'Spills something on keyboard',
    ],
    [
        1,
        'Yells "watch your mouth" at someone in chat',
        'Yells "I don\'t like your attitude" at someone in chat',
    ],
    'Speaks gibberish when someone resubs',
    [
        1,
        'Threatens to cry on stream',
        'Cries on stream',
    ],
    [
        1,
        'Tells the Fritos story again',
        'Refuses to tell the Fritos story again',
    ],
    'Uses a bad MS Paint drawing to explain something',
    'Threatens chat by holding a knife to the camera',
    'Talks about people who hate her',
    'Uses the word "cooch-hole"',
    'Throws up on or off cam',
    'BlueGuy',
    'Hides sweaty armpits by covering them with hands',
    'Threatens to fire a mod',
    'Tells a cringe inducing story from her childhood',
    'Explains some zoomer shit she learned on TikTok',
    'Describes a food as "It\'s not that bad"',
    'Calls someone an "Andy"',
    'Tells chat that she doesn\'t want to peg us',
    'Talks about cartoon animals with sexual energy',
    'Talks about how great Buc-ee\'s is"',
    'Abuses Koby',
    [
        'Tells chat to stop talking about cum',
        'Talks about cum',
    ],
    'Asks chat if she\'s allowed to pee',
    'Any sentence of two words or more repeated three times or more in a row',
    'Technical difficulties',
    [
        1,
        'Mentions someone pissing their pants',
        'Mentions someone shitting their pants',
    ],
    'Plugs the YouTube channel',
    'Talks shit about DS2 or DS2 viewers',
    [
        'Ironically promotes incest',
        'Unironically denounces incest',
    ],
    'Says "PUSSY" in a weird, high-pitched voice',
];

// Mutable global data
var rand = null;
var card_data = null;
var seed = null;

function assert(cond, msg) {
    if (!cond) {
        throw msg;
    }
}

function spam(text) {
    spam_box.innerText += text;
    spam_box.innerHTML += "<br>";
}

function hash(str) {
    var hash = 0;
    if (str.length === 0) {
        return hash;
    }
    for (var i = 0; i < str.length; i++) {
        var ch = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + ch;
        hash = hash & hash; // Convert to 32bit integer
    }
    return hash;
}

function splitmix32(a) {
    return function() {
      a |= 0; a = a + 0x9e3779b9 | 0;
      var t = a ^ a >>> 15; t = Math.imul(t, 0x85ebca6b);
      t = t ^ t >>> 13; t = Math.imul(t, 0xc2b2ae35);
      return ((t = t ^ t >>> 16) >>> 0) / 4294967296;
    }
}

function set_cookie(name, value, expire_days) {
    let d = new Date();
    d.setTime(d.getTime() + (expire_days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${value}; expires=${d.toUTCString()}; samesite=strict; path=/`;
}

function get_cookies() {
    let result = new Map();
    for (let key_val of document.cookie.split(';')) {
        key_val.trim();
        let eq = key_val.indexOf("=");
        if (eq === -1) {
            result.set(key_val, "");
        } else {
            let key = key_val.slice(0, eq);
            key.trim();
            let val = key_val.slice(eq + 1);
            val.trim();
            result.set(key, val);
        }
    }
    return result;
}

function shuffle(array) {
    let currentIndex = array.length;
    while (0 !== currentIndex) {

        // Pick a remaining element...
        let randomIndex = Math.floor(rand() * currentIndex);
        currentIndex -= 1;

        // And swap it with the current element.
        let temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
    }
}

function update_url_box() {
    let page = window.location.href.split("?")[0];
    let state = get_card_state();
    let url = `${page}?seed=${seed}&state=${state}`;
    // TODO make this a link
    url_box.innerText = url;
}

function clicked_td(cell_id) {
    card_data[cell_id].classList.toggle("checked");
    update_url_box();
}

function clicked_url_button() {
    if (url_box.classList.toggle("hidden")) {
        url_button.innerText = "Share this card";
    } else {
        url_button.innerText = "Hide link";
    }
}
function clicked_reset_button() {
    for (let cell of card_data) {
        cell.classList.remove("checked");
    }
    update_url_box();
}

function gen_table(table, strings) {
    let cells = [];
    for (let i = 0; i < bingo_size; ++i) {
        let row_elem = table.insertRow();
        for (let j = 0; j < bingo_size; ++j) {
            let td = document.createElement("td");
            let text = document.createTextNode(strings[cells.length]);

            td.setAttribute("onclick", `clicked_td(${cells.length})`);

            td.appendChild(text);
            row_elem.appendChild(td);
            cells.push(td);
        }
    }
    return cells;
}

function get_card_state() {
    let bits = 0;
    let bit_count = 0;
    for (let cell of card_data) {
        if (cell.classList.contains("checked")) {
            bits |= 1 << bit_count;
        }
        ++bit_count;
    }
    return bits.toString(param_str_base);
}

// Execution starts here
function main() {
    let search_params = new URLSearchParams(window.location.search);

    seed = search_params.get("seed");
    if (seed === null) {
        let cookies = get_cookies();
        let unique_id;
        if (cookies.has("id")) {
            unique_id = cookies.get("id");
        } else {
            let id_int = Math.floor(Math.random() * (1 << 20));
            unique_id = id_int.toString(param_str_base);
            set_cookie("id", unique_id);
        }
        seed = unique_id; // TODO add date
    }

    rand = splitmix32(hash(seed));

    let strings = [];
    {
        let remaining = [...cells_text];
        while (strings.length < bingo_num_cells) {
            if (remaining.length === 0) {
                // If we don't have enough items, add dupes
                assert(false, "Not enough items");
                remaining = [...cells_text];
            }
            let index = Math.floor(rand() * remaining.length);
            let chosen = remaining[index];
            if (typeof(chosen) === "string") {
                strings.push(chosen);
            } else if (typeof(chosen[0]) == "number") {
                let choices = chosen.slice(1);
                shuffle(choices);
                let take = chosen[0];
                for (let choice of choices) {
                    if (take <= 0)
                        break;
                    --take;
                    strings.push(choice);
                }
            } else {
                for (let elem of chosen) {
                    strings.push(elem);
                }
            }
            remaining.splice(index, 1);
        }
    }
    shuffle(strings);

    let table = document.querySelector(".body_table");
    card_data = gen_table(table, strings);

    let state_str = search_params.get("state");
    if (state_str !== null) {
        let state_num = parseInt(state_str, param_str_base);
        for (let i = 0; i < card_data.length; ++i, state_num >>= 1) {
            if (state_num & 1) {
                card_data[i].classList.add("checked");
            }
        }
    }

    update_url_box();

    // TODO:
    //  colours
    //  Auto detect bingo
    //  make BlueGuy cell highlight in blue
}

main();

</script>
</html>
