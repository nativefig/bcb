<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>B E R R Y C R E P E B I N G O</title>
</head>

<body>
<div class="center">
<table class="card card_head card_width">
<tr><td><div>B</div></td> <td><div>E</div></td> <td><div>R</div></td> <td><div>R</div></td> <td><div>Y</div></td></tr>
<tr><td><div>C</div></td> <td><div>R</div></td> <td><div>E</div></td> <td><div>P</div></td> <td><div>E</div></td></tr>
<tr><td><div>B</div></td> <td><div>I</div></td> <td><div>N</div></td> <td><div>G</div></td> <td><div>O</div></td></tr>
</table>
</div>

<div class="center">
<table class="card card_body card_width">
</table>
</div>

<div class="center">
<div id="button_box" class="card_width">
<button id="url_button" type="button" onclick="clicked_url_button()">Share this card</button>
</div>
</div>

<div class="center">
<div id="url_box" class="card_width hidden">
</div>
</div>

<div class="center">
<div id="spam_box" class="card_width">
</div>
</div>

</body>

<style>
    @media screen and (orientation:landscape) {
        .card_body {
            height: 75vmin;
        }
        .card_width {
            width: 75vmin;
        }
    }
    @media screen and (orientation:portrait) {
        .card_body {
            height: 85vmin;
        }
        .card_width {
            width: 85vmin;
        }
    }

    .center {
        display: flex;
        justify-content: center;
    }
    .card td {
        width: 20%;
    }
    .card_head td {
        padding: 0.2rem;
        font-weight: bold;
        text-align: center;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 2.5vmin;
    }
    .card_body {
        border-collapse: collapse;
        background-color: seashell;
        box-shadow: 3px 3px 8px #707070;
    }
    .card_body td {
        height: 20%;
        border: 3px solid #202020;
        text-align: center;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 1.7vmin;
        padding: 1.5%;
    }
    .checked {
        background-color: tomato;
    }
    body {
        background-color: thistle;
        color: #202020;
        font-family: Arial, Helvetica, sans-serif;
    }
    #url_box {
        padding-top: 0.5rem;
        padding-left: 2rem;
    }
    #button_box {
        padding-top: 2rem;
    }
    #url_button {
        width: 10rem;
    }
    .hidden {
        display: none;
    }
</style>

<script>
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

const bingo_size = 5;
const bingo_num_cells = bingo_size * bingo_size;
const param_str_base = 32;

const spam_box = document.getElementById("spam_box");
const url_box = document.getElementById("url_box");
const url_button = document.getElementById("url_button");

const cells_text = [
    '"I just spit everywhere, I\'m so spitty"',
    '"I don\'t know how to explain it"',
    '"I\'m gonna get in trouble"',
    '"Popeyes called me stupid"',
    '"I don\'t know what we\'re doing tomorrow"',
    '"Feet aren\'t free"',
    '"It\'s not a vape"',
    '"I signed the DARE contract"',
    '"I hope my dad isn\'t watching"',
    '"Do I have a coomer chat?"',
    '"I\'ve been yelling a lot less, I used to be worse"',

    'Describes a food as "It\'s not that bad"',
    'Calls someone an "Andy"',
    'Tells chat that she doesn\'t want to peg us',
    'Talks about cartoon animals with sexual energy',
    'Talks about how great Buc-ee\'s is"',
    'Abuses Koby',
    [
        'Tells chat to stop talking about cum',
        'Talks about cum',
    ],
    'Asks chat if she\'s allowed to pee',
    'Any sentence of two words or more repeated three times or more in a row',
    'Technical difficulties',
    [
        'Mentions someone pissing their pants',
        'Mentions someone shitting their pants',
    ],
    'Plugs the YouTube channel',
    'Talks shit about DS2 or DS2 viewers',
    [
        'Ironically promotes incest',
        'Unironically denounces incest',
    ],
    'Says "PUSSY" in a weird, high-pitched voice',
];

// Mutable global data
var rand = null;
var card_data = null;
var seed = null;

function assert(cond, msg) {
    if (!cond) {
        throw msg;
    }
}

function spam(text) {
    spam_box.innerText += text;
    spam_box.innerHTML += "<br>";
}

function hash(str) {
    var hash = 0;
    if (str.length === 0) {
        return hash;
    }
    for (var i = 0; i < str.length; i++) {
        var ch = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + ch;
        hash = hash & hash; // Convert to 32bit integer
    }
    return hash;
}

function splitmix32(a) {
    return function() {
      a |= 0; a = a + 0x9e3779b9 | 0;
      var t = a ^ a >>> 15; t = Math.imul(t, 0x85ebca6b);
      t = t ^ t >>> 13; t = Math.imul(t, 0xc2b2ae35);
      return ((t = t ^ t >>> 16) >>> 0) / 4294967296;
    }
}

function set_cookie(name, value, expire_days) {
    let d = new Date();
    d.setTime(d.getTime() + (expire_days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${value}; expires=${d.toUTCString()}; samesite=strict; path=/`;
}

function get_cookies() {
    let result = new Map();
    for (let key_val of document.cookie.split(';')) {
        key_val.trim();
        let eq = key_val.indexOf("=");
        if (eq === -1) {
            result.set(key_val, "");
        } else {
            let key = key_val.slice(0, eq);
            key.trim();
            let val = key_val.slice(eq + 1);
            val.trim();
            result.set(key, val);
        }
    }
    return result;
}

function shuffle(array) {
    let currentIndex = array.length;
    while (0 !== currentIndex) {

        // Pick a remaining element...
        let randomIndex = Math.floor(rand() * currentIndex);
        currentIndex -= 1;

        // And swap it with the current element.
        let temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
    }
}

function update_url_box() {
    let page = window.location.href.split("?")[0];
    let state = get_card_state();
    let url = `${page}?seed=${seed}&state=${state}`;
    url_box.innerText = url;
}

function clicked_td(cell_id) {
    card_data[cell_id].classList.toggle("checked");
    update_url_box();
}

function clicked_url_button() {
    if (url_box.classList.toggle("hidden")) {
        url_button.innerText = "Share this card";
    } else {
        url_button.innerText = "Hide URL";
    }
}

function gen_table(table, strings) {
    let cells = [];
    for (let i = 0; i < bingo_size; ++i) {
        let row_elem = table.insertRow();
        for (let j = 0; j < bingo_size; ++j) {
            let td = document.createElement("td");
            let text = document.createTextNode(strings[cells.length]);

            td.setAttribute("onclick", `clicked_td(${cells.length})`);

            td.appendChild(text);
            row_elem.appendChild(td);
            cells.push(td);
        }
    }
    return cells;
}

function get_card_state() {
    let bits = 0;
    let bit_count = 0;
    for (let cell of card_data) {
        if (cell.classList.contains("checked")) {
            bits |= 1 << bit_count;
        }
        ++bit_count;
    }
    return bits.toString(param_str_base);
}

// Execution starts here
function main() {
    let search_params = new URLSearchParams(window.location.search);

    seed = search_params.get("seed");
    if (seed === null) {
        let cookies = get_cookies();
        let unique_id;
        if (cookies.has("id")) {
            unique_id = cookies.get("id");
        } else {
            let id_int = Math.floor(Math.random() * (1 << 20));
            unique_id = id_int.toString(param_str_base);
            set_cookie("id", unique_id);
        }
        seed = unique_id; // TODO add date
    }

    rand = splitmix32(hash(seed));

    let strings = [];
    {
        let remaining = [...cells_text];
        while (strings.length < bingo_num_cells) {
            if (remaining.length === 0) {
                // If we don't have enough items, add dupes
                assert(false, "Not enough items");
                remaining = [...cells_text];
            }
            let index = Math.floor(rand() * remaining.length);
            let chosen = remaining[index];
            if (typeof(chosen) === "string") {
                strings.push(chosen);
            } else {
                for (let elem of chosen) {
                    strings.push(elem);
                }
            }
            remaining.splice(index, 1);
        }
    }
    shuffle(strings);

    let table = document.querySelector(".card_body");
    card_data = gen_table(table, strings);

    let state_str = search_params.get("state");
    if (state_str !== null) {
        let state_num = parseInt(state_str, param_str_base);
        for (let i = 0; i < card_data.length; ++i, state_num >>= 1) {
            if (state_num & 1) {
                card_data[i].classList.add("checked");
            }
        }
    }

    update_url_box();

    // TODO:
    //  colours
    //  Auto detect bingo
    //  reset button
}

main();

</script>
</html>
